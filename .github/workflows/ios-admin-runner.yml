name: iOS Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - appstore
  push:
    branches:
      - main
    paths:
      - 'CHANGELOG_TRIGGER.md'

jobs:
  build-ios:
    runs-on: macos-latest
    
    env:
      # Check if App Store secrets are configured
      HAS_APPSTORE_CONFIG: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID != '' && secrets.APP_STORE_CONNECT_ISSUER_ID != '' && secrets.APPLE_TEAM_ID != '' }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: hardik-kanajariya/apanavyapar
          token: ${{ secrets.PAT_TOKEN }}
          ref: feature/android
          path: repo

      - name: Verify Clone & List Structure
        run: |
          echo "ðŸ“ Workspace root:"
          ls -la
          echo ""
          echo "ðŸ“ Inside repo:"
          ls -la repo/
          echo ""
          echo "ðŸ“ Inside repo/admin-app:"
          ls -la repo/admin-app/ || echo "âŒ admin-app directory NOT FOUND"

      - name: Determine Build Type
        id: build_config
        run: |
          # If manually triggered, use the input; otherwise check if secrets exist
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD_TYPE="${{ inputs.build_type }}"
          elif [ "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" != "" ] && [ "${{ secrets.APPLE_TEAM_ID }}" != "" ]; then
            BUILD_TYPE="appstore"
          else
            BUILD_TYPE="development"
          fi
          
          echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "ðŸ”¨ Build Type: $BUILD_TYPE"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Get package-lock hash
        id: pkg-hash
        run: |
          HASH=$(md5 -q repo/admin-app/package-lock.json 2>/dev/null || echo "no-lock-file")
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ steps.pkg-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        working-directory: repo/admin-app
        run: npm install

      - name: Verify iOS directory exists
        run: |
          echo "ðŸ“ Checking iOS directory:"
          ls -la repo/admin-app/ios/ || echo "âŒ ios directory NOT FOUND - Make sure your React Native project has an ios folder"

      - name: Install CocoaPods dependencies
        working-directory: repo/admin-app/ios
        run: |
          sudo gem install cocoapods
          pod install

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get Scheme Name
        id: scheme
        working-directory: repo/admin-app/ios
        run: |
          SCHEME=$(xcodebuild -list -workspace *.xcworkspace 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
          if [ -z "$SCHEME" ]; then
            SCHEME=$(xcodebuild -list -project *.xcodeproj 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
          fi
          echo "SCHEME_NAME=$SCHEME" >> $GITHUB_OUTPUT
          echo "ðŸ“± Found scheme: $SCHEME"

      # ==========================================
      # DEVELOPMENT BUILD (No signing required)
      # ==========================================
      - name: Build Development IPA (Unsigned)
        if: steps.build_config.outputs.BUILD_TYPE == 'development'
        working-directory: repo/admin-app/ios
        run: |
          echo "ðŸ”§ Building DEVELOPMENT (unsigned) IPA..."
          
          SCHEME="${{ steps.scheme.outputs.SCHEME_NAME }}"
          
          # Clean and build archive without signing
          xcodebuild clean archive \
            -workspace *.xcworkspace \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $RUNNER_TEMP/app.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            -allowProvisioningUpdates
          
          # Create IPA manually from the .app
          echo "ðŸ“¦ Creating IPA package..."
          mkdir -p $RUNNER_TEMP/Payload
          cp -r $RUNNER_TEMP/app.xcarchive/Products/Applications/*.app $RUNNER_TEMP/Payload/
          cd $RUNNER_TEMP
          zip -r app-dev-unsigned.ipa Payload
          mkdir -p ipa
          mv app-dev-unsigned.ipa ipa/
          
          echo "âœ… Development IPA created successfully!"

      # ==========================================
      # APP STORE BUILD (Signed with Fastlane)
      # ==========================================
      - name: Install Fastlane
        if: steps.build_config.outputs.BUILD_TYPE == 'appstore'
        run: gem install fastlane

      - name: Create App Store Connect API Key
        if: steps.build_config.outputs.BUILD_TYPE == 'appstore'
        working-directory: repo/admin-app/ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8

      - name: Create Keychain
        if: steps.build_config.outputs.BUILD_TYPE == 'appstore'
        run: |
          security create-keychain -p "temp_password" $RUNNER_TEMP/app-signing.keychain-db
          security set-keychain-settings -lut 21600 $RUNNER_TEMP/app-signing.keychain-db
          security unlock-keychain -p "temp_password" $RUNNER_TEMP/app-signing.keychain-db
          security list-keychain -d user -s $RUNNER_TEMP/app-signing.keychain-db

      - name: Setup Fastlane & Sync Certificates
        if: steps.build_config.outputs.BUILD_TYPE == 'appstore'
        working-directory: repo/admin-app/ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          BUNDLE_IDENTIFIER: ${{ secrets.BUNDLE_IDENTIFIER }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          KEYCHAIN_PATH: ${{ runner.temp }}/app-signing.keychain-db
        run: |
          echo "ðŸ” Setting up Fastlane for App Store build..."
          
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'EOF'
          default_platform(:ios)

          platform :ios do
            desc "Sync certificates and profiles"
            lane :sync_certs do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: File.expand_path("~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8"),
                in_house: false
              )

              match(
                type: "appstore",
                app_identifier: ENV["BUNDLE_IDENTIFIER"],
                team_id: ENV["APPLE_TEAM_ID"],
                git_url: ENV["MATCH_GIT_URL"],
                git_basic_authorization: ENV["MATCH_GIT_BASIC_AUTHORIZATION"],
                keychain_name: ENV["KEYCHAIN_PATH"],
                keychain_password: "temp_password",
                api_key: api_key,
                readonly: false
              )
            end

            desc "Build and export IPA"
            lane :build_ipa do
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                key_filepath: File.expand_path("~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8"),
                in_house: false
              )

              update_code_signing_settings(
                use_automatic_signing: false,
                team_id: ENV["APPLE_TEAM_ID"],
                bundle_identifier: ENV["BUNDLE_IDENTIFIER"],
                profile_name: "match AppStore #{ENV['BUNDLE_IDENTIFIER']}",
                code_sign_identity: "iPhone Distribution"
              )

              build_app(
                workspace: Dir.glob("*.xcworkspace").first,
                scheme: ENV["SCHEME_NAME"],
                configuration: "Release",
                export_method: "app-store",
                output_directory: ENV["RUNNER_TEMP"] + "/ipa",
                output_name: "app-appstore.ipa",
                export_options: {
                  signingStyle: "manual",
                  teamID: ENV["APPLE_TEAM_ID"]
                }
              )
            end
          end
          EOF

          fastlane sync_certs

      - name: Build App Store IPA
        if: steps.build_config.outputs.BUILD_TYPE == 'appstore'
        working-directory: repo/admin-app/ios
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          BUNDLE_IDENTIFIER: ${{ secrets.BUNDLE_IDENTIFIER }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          SCHEME_NAME: ${{ steps.scheme.outputs.SCHEME_NAME }}
          KEYCHAIN_PATH: ${{ runner.temp }}/app-signing.keychain-db
        run: |
          echo "ðŸ—ï¸ Building App Store IPA..."
          fastlane build_ipa
          echo "âœ… App Store IPA created successfully!"

      # ==========================================
      # UPLOAD ARTIFACT (Both build types)
      # ==========================================
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ steps.build_config.outputs.BUILD_TYPE }}
          path: ${{ runner.temp }}/ipa/*.ipa
          retention-days: 14
          if-no-files-found: error

      - name: Build Summary
        run: |
          echo "## ðŸ“± iOS Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | **${{ steps.build_config.outputs.BUILD_TYPE }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Scheme | ${{ steps.scheme.outputs.SCHEME_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | ios-ipa-${{ steps.build_config.outputs.BUILD_TYPE }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.build_config.outputs.BUILD_TYPE }}" == "development" ]; then
            echo "âš ï¸ **Note:** This is an unsigned development build. To create a signed App Store build, configure the required secrets." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… This is a signed App Store build ready for distribution." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Clean up keychain
        if: always() && steps.build_config.outputs.BUILD_TYPE == 'appstore'
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
